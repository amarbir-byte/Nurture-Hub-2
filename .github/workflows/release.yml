name: ğŸš€ Production Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.2.3)'
        required: true
        type: string

env:
  NODE_VERSION: '20'

jobs:
  # ğŸ“‹ Pre-release Validation
  pre-release-validation:
    name: ğŸ“‹ Pre-release Validation
    runs-on: ubuntu-latest
    timeout-minutes: 20

    outputs:
      version: ${{ steps.version.outputs.version }}
      is-prerelease: ${{ steps.version.outputs.prerelease }}

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline

      - name: ğŸ” Extract Version Information
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Check if this is a prerelease (contains alpha, beta, rc)
          if [[ "$VERSION" =~ (alpha|beta|rc) ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi

          echo "Release version: $VERSION"

      - name: âœ… Comprehensive Test Suite
        run: |
          echo "ğŸ§ª Running comprehensive test suite for release..."

          # Type checking
          npm run typecheck

          # Linting
          npm run lint

          # Security audit
          npm run security:audit

          # Unit tests with coverage
          npm run test:unit -- --coverage --watchAll=false

          # Integration tests
          npm run test:integration -- --watchAll=false

          # Database migration tests
          npm run db:test ci

      - name: ğŸ—ï¸ Production Build
        run: |
          echo "ğŸ—ï¸ Creating production build..."
          npm run build

          # Verify build artifacts
          ls -la dist/
          echo "Build size: $(du -sh dist/)"

      - name: ğŸ“Š Performance Validation
        run: |
          echo "ğŸ“Š Validating performance metrics..."

          # Check bundle size limits
          MAX_MAIN_BUNDLE=1048576  # 1MB
          MAX_VENDOR_BUNDLE=2097152  # 2MB

          MAIN_SIZE=$(find dist -name "index-*.js" -exec du -b {} \; | cut -f1 | head -1)
          VENDOR_SIZE=$(find dist -name "vendor-*.js" -exec du -b {} \; | cut -f1 | head -1)

          echo "Main bundle: $MAIN_SIZE bytes (limit: $MAX_MAIN_BUNDLE)"
          echo "Vendor bundle: $VENDOR_SIZE bytes (limit: $MAX_VENDOR_BUNDLE)"

          if [ $MAIN_SIZE -gt $MAX_MAIN_BUNDLE ]; then
            echo "âŒ Main bundle exceeds size limit"
            exit 1
          fi

          if [ $VENDOR_SIZE -gt $MAX_VENDOR_BUNDLE ]; then
            echo "âŒ Vendor bundle exceeds size limit"
            exit 1
          fi

      - name: ğŸ”’ Security Final Check
        run: |
          echo "ğŸ”’ Final security validation..."

          # Check for any hardcoded secrets in build
          if grep -r "sk_test\|pk_test\|secret" dist/ 2>/dev/null; then
            echo "âŒ Potential secrets found in build artifacts"
            exit 1
          fi

          # Verify no development dependencies in production build
          if find dist/ -name "*.map" | grep -v ".js.map$"; then
            echo "âš ï¸ Found non-JS source maps in production build"
          fi

  # ğŸ—„ï¸ Database Backup & Migration
  database-preparation:
    name: ğŸ—„ï¸ Database Preparation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: pre-release-validation

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v5

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline

      - name: ğŸ“¸ Create Production Backup
        run: |
          echo "ğŸ“¸ Creating production database backup..."
          npm run db:enterprise snapshot production pre-release-${{ needs.pre-release-validation.outputs.version }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          PROD_PROJECT_REF: ${{ secrets.PROD_PROJECT_REF }}

      - name: ğŸ§ª Test Migrations on Staging
        run: |
          echo "ğŸ§ª Testing migrations on staging environment..."

          # Apply migrations to staging first
          npm run db:enterprise deploy staging

          # Validate schema integrity
          npm run db:validate

          # Test rollback capability
          npm run db:enterprise test
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          STAGING_PROJECT_REF: ${{ secrets.STAGING_PROJECT_REF }}

  # ğŸš€ Production Deployment
  production-deployment:
    name: ğŸš€ Production Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [pre-release-validation, database-preparation]
    environment: production

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v5

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline

      - name: ğŸ—„ï¸ Apply Production Migrations
        run: |
          echo "ğŸ—„ï¸ Applying database migrations to production..."
          npm run db:enterprise deploy production
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          PROD_PROJECT_REF: ${{ secrets.PROD_PROJECT_REF }}

      - name: ğŸš€ Deploy to Vercel Production
        uses: amondnet/vercel-action@v25
        id: vercel-deployment
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          scope: ${{ secrets.VERCEL_ORG_ID }}
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: â³ Wait for Deployment Propagation
        run: |
          echo "â³ Waiting for deployment to propagate globally..."
          sleep 120  # Wait 2 minutes for global propagation

  # ğŸ§ª Post-deployment Validation
  post-deployment-validation:
    name: ğŸ§ª Post-deployment Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: production-deployment

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v5

      - name: ğŸŒ Health Check
        run: |
          echo "ğŸŒ Performing comprehensive health check..."

          PROD_URL="https://nurture-hub.vercel.app"

          # Test main endpoint
          for i in {1..10}; do
            if curl -f "$PROD_URL" > /dev/null 2>&1; then
              echo "âœ… Main endpoint healthy"
              break
            fi
            echo "â³ Waiting for endpoint... ($i/10)"
            sleep 30
          done

          # Test API endpoints
          API_ENDPOINTS=(
            "/api/health"
            "/api/dashboard/stats"
            "/api/properties"
            "/api/contacts"
          )

          for endpoint in "${API_ENDPOINTS[@]}"; do
            if curl -f "${PROD_URL}${endpoint}" > /dev/null 2>&1; then
              echo "âœ… $endpoint healthy"
            else
              echo "âŒ $endpoint failed"
            fi
          done

      - name: âš¡ Performance Validation
        run: |
          echo "âš¡ Running performance validation..."

          # Test page load times
          LOAD_TIME=$(curl -o /dev/null -s -w '%{time_total}' https://nurture-hub.vercel.app)
          echo "Page load time: ${LOAD_TIME}s"

          # Acceptable load time is under 3 seconds
          if (( $(echo "$LOAD_TIME > 3.0" | bc -l) )); then
            echo "âš ï¸ Page load time exceeds 3 seconds"
          else
            echo "âœ… Page load time within acceptable range"
          fi

      - name: ğŸ”’ Security Headers Validation
        run: |
          echo "ğŸ”’ Validating security headers..."

          RESPONSE=$(curl -I https://nurture-hub.vercel.app 2>/dev/null)

          # Required security headers
          SECURITY_HEADERS=(
            "X-Content-Type-Options: nosniff"
            "X-Frame-Options"
            "X-XSS-Protection"
            "Strict-Transport-Security"
          )

          for header in "${SECURITY_HEADERS[@]}"; do
            if echo "$RESPONSE" | grep -qi "$header"; then
              echo "âœ… $header present"
            else
              echo "âš ï¸ $header missing"
            fi
          done

      - name: ğŸ—„ï¸ Database Connectivity Test
        run: |
          echo "ğŸ—„ï¸ Testing database connectivity..."

          # Test basic database operations
          npm run db:status
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

  # ğŸ“Š Release Documentation
  create-release:
    name: ğŸ“Š Create Release Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [pre-release-validation, post-deployment-validation]
    if: always() && needs.post-deployment-validation.result == 'success'

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: ğŸ“‹ Generate Changelog
        id: changelog
        run: |
          echo "ğŸ“‹ Generating changelog..."

          # Get the previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "Changes since $PREVIOUS_TAG:"
            git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD > CHANGELOG.txt
          else
            echo "Initial release" > CHANGELOG.txt
          fi

          cat CHANGELOG.txt

      - name: ğŸ·ï¸ Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.pre-release-validation.outputs.version }}
          release_name: Release ${{ needs.pre-release-validation.outputs.version }}
          body_path: ./CHANGELOG.txt
          draft: false
          prerelease: ${{ needs.pre-release-validation.outputs.is-prerelease }}

  # ğŸ“ˆ Performance Monitoring Setup
  setup-monitoring:
    name: ğŸ“ˆ Setup Release Monitoring
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [pre-release-validation, post-deployment-validation]
    if: always() && needs.post-deployment-validation.result == 'success'

    steps:
      - name: ğŸ“Š Configure Release Monitoring
        run: |
          echo "ğŸ“Š Setting up monitoring for release ${{ needs.pre-release-validation.outputs.version }}"

          # Here you would typically:
          # 1. Set up monitoring dashboards
          # 2. Configure alerts for the new release
          # 3. Initialize performance baselines
          # 4. Set up error tracking for the release

          echo "âœ… Monitoring configured for release"

  # ğŸ“± Notification
  notify-stakeholders:
    name: ğŸ“± Notify Stakeholders
    runs-on: ubuntu-latest
    needs: [pre-release-validation, post-deployment-validation, create-release]
    if: always()

    steps:
      - name: ğŸ‰ Success Notification
        if: needs.post-deployment-validation.result == 'success'
        run: |
          echo "ğŸ‰ Production release ${{ needs.pre-release-validation.outputs.version }} deployed successfully!"

          RELEASE_NOTES="
          ğŸš€ **Production Release ${{ needs.pre-release-validation.outputs.version }}**

          **âœ… Deployment Status:** Successful
          **ğŸŒ Live URL:** https://nurture-hub.vercel.app
          **ğŸ“… Deploy Time:** $(date -u)
          **ğŸ”— Release Notes:** https://github.com/${{ github.repository }}/releases/tag/${{ needs.pre-release-validation.outputs.version }}

          **âœ… Validation Results:**
          - Health checks: Passed
          - Performance: Passed
          - Security headers: Validated
          - Database connectivity: Verified

          **ğŸ“Š Key Metrics:**
          - Build time: < 5 minutes
          - Deployment time: < 10 minutes
          - Page load time: < 3 seconds

          Ready for production traffic! ğŸš€
          "

          echo "$RELEASE_NOTES"

          # Here you would send notifications to:
          # - Slack channels
          # - Email lists
          # - Discord servers
          # - Team dashboards

      - name: ğŸš¨ Failure Notification
        if: needs.post-deployment-validation.result == 'failure'
        run: |
          echo "ğŸš¨ Production release ${{ needs.pre-release-validation.outputs.version }} failed!"

          FAILURE_ALERT="
          ğŸš¨ **Production Release FAILED**

          **âŒ Version:** ${{ needs.pre-release-validation.outputs.version }}
          **ğŸ“… Time:** $(date -u)
          **ğŸ”— Workflow:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

          **ğŸ›‘ Immediate Actions Required:**
          1. Check workflow logs for failure details
          2. Verify production system status
          3. Consider rollback if necessary
          4. Notify development team

          **ğŸ“Š System Status:**
          - Database: Check required
          - Application: Needs validation
          - Monitoring: Review alerts

          Please investigate immediately! ğŸš¨
          "

          echo "$FAILURE_ALERT"

          # Send critical failure notifications